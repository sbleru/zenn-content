---
title: "本番運用から始めるTerraform - フォルダ構成"
emoji: "😊"
type: "tech"
topics: []
published: false
---

# はじめに

- Terraformについて書かれた良記事はいくらでもあるので、この記事では筆者のコンテキストをまず見てもらって、同じような状況で気づきを得られそうなら参考に読んでもらえたらと思います。
- 運用途中なので中途半端な内容も含みますmm（追記予定などのコメントをしておく）
	- 筆者の疑問解決型で記事アプデ or 追加していく予定です

# コンテキスト

- IaCでインフラを管理せずにアプリケーションを本番運用してきており、アプリケーション規模やチーム規模もそこそこ大きくなってきて、以下のようなペインを抱えており、安全に効率よくインフラを管理したいと考えている
	- 開発環境ではうまくいってるのに本番環境でエラーが出てしまい、原因究明に時間がかかる
	- すでにあるインフラ構成と同じインフラ構成を別で作りたいだけなのに、コンソールを見比べてポチポチ設定するのが大変だし間違う可能性がある。チームメンバーにレクチャーするためのドキュメント整備も大変である。
- IaC導入が良さそうというのは分かっているが、本番運用にあたって以下のような疑問がある
	- なぜ Terraform がいいんだろう。他のIaCツールが良かったりするんだろうか
	- アプリケーションコードより改修が難しそうだし、最適なフォルダ構成や方針はなんだろう
	- もしリファクタリングしたい場合はどうするんだろう
	- セキュアな情報はどう管理すればいいんだろう
	- インフラが本番稼働してるけど、導入はどうしたらいいんだろう
	- CI/CDはどうしたらいんだろう

方へ向けて、IaCであるTerraformを本番運用するために考えたこと、実践したことの備忘録。
（インフラとしてGoogle Cloudを取り扱いますが、AWSについてもどこかで追記できたら）

また、この記事の内容は [詳解 Terraform 第3版](https://www.oreilly.co.jp/books/9784814400522/) をおおいに参考にしています。ある程度Terraform分かってるよという方はここに運用に関する答えがほぼあるので読んでみることをお勧めします。

自分は正直Terraformとっつきにくいと感じていたのですが、以下のような手順を踏み、Terraformいいな！となっていきました。

チュートリアル触る
→ terraform完全に理解した
→ いやterraformむっず、記事とか読んで試行錯誤
→ オライリー本読んでむずいポイント穴埋めして理解が進む
→ これでいけそう！

なので、Terraform触ってない方は、まずは難しいこと考えずにTerraform触ってみて、そこから本番運用のことを考えるといいと思います。
こちらの記事が何も考えずに手順に従って進められたので良かったです。
[Terraform を使って Google Cloud のリソースを管理することはじめ（gloud authを利用）](https://zenn.dev/waddy/articles/terraform-google-cloud)

# Terraformのポイント

- Terraformは宣言的である
    - 最終的な状態を宣言するだけで良く、その状態管理はTerraformが判断してくれる
    - ChefやAnsibleなどの手続き型では、インフラ構築の手順を一つ一つ定義していくことになり、再実行時の考慮が必要になってくる
- 最小限の影響で済む構成を心がける
    - インフラの更新は、サービス稼働に直結する。また、リソースによって更新頻度が異なる。更新頻度の多いリソースを更新するたびに、万が一でも本来変更のないリソースに影響が及ぶことを避けたい。そのため後述するフォルダ構成を意識するなど、更新時の影響箇所を小さくしておくことが重要。
- 本番レベルのインフラ構築は時間がかかる

# 用語

- stateファイル
    - 
- provider
    - awsとかgoogle cloudとか
- resource
    - 構築対象のインフラのリソース
- data
    - 元々あるインフラリソースを扱える
- modules
    - 再利用可能なインフラリソースを作ることができる、関数のようなもの
- variable
    - 変数

# Terraform のフォルダ構成

```bash
> tree
├── README.md
├── dev
│   ├── data-storage
│   │   └── postgresql
│   │       ├── import.tf
│   │       ├── main.tf
│   │       ├── output.tf
│   │       ├── terraform.tf
│   │       └── variable.tf
│   └── service
│       ├── a-web-api
│       │   ├── main.tf
│       │   ├── terraform.tf
│       │   └── variable.tf
│       └── github-deploy
│           ├── main.tf
│           ├── terraform.tf
│           └── variable.tf
├── module
│   └── service
│       ├── github-deploy-workload-identity
│       │   ├── main.tf
│       │   └── variable.tf
│       └── web-api-cloud-run-service
│           ├── main.tf
│           └── variable.tf
└── prod
    ├── data-storage
    │   └── postgresql
    │       ├── import.tf
    │       ├── main.tf
    │       ├── output.tf
    │       ├── terraform.tf
    │       └── variable.tf
    └── service
        ├── a-api
        │   ├── main.tf
        │   ├── terraform.tf
        │   └── variable.tf
        └── github-deploy
            ├── main.tf
            ├── terraform.tf
            └── variable.tf

```

- フォルダ分けの方針
    - 最小限の影響で済むように、dev・prodなどの開発環境やデータストア、サービスごとにtfstateの管理を分ける
- dev, prod
    - 環境ごとにフォルダを分け、別のtfstate管理とする
- data-storage
    - PostgreSQLなど、この環境内で動かすデータストア用。他のデータストとはtfstateの管理を分離するようにする。データストアとserviceの変更頻度を比較すると、serviceの方が圧倒的に頻度が高いと考えられるため、serviceの変更のたびにデータストアへの影響を気にしたくないため。
- service
    - web api のアプリケーションなど、この環境で動かすアプリケーションあるいはマイクロサービス。他のアプリケーションとはtfstateの管理を分離するようにする
- module
    - 各アプリケーションが共通で使う。ここにはアプリケーション依存のものは入り込まないようにする。tfstateの管理も行わない。
- terraform.tf
    - terraform bucket の定義、providerの定義
- main.tf
    - インフラリソース、データソースの定義
- variable.tf
    - 入力変数
- output.tf
    - 出力変数
- import.tf
    - すでにインフラリソースがある場合にimportを行う

※補足

- terraformはtfstateフォルダ直下をフラットに扱うため、ファイル名が何であっても読み込まれる

## 命名規則

- [Naming conventions - Terraform Best Practices](https://www.terraform-best-practices.com/naming)
- スネークケース

# Terraform の実行

## 基本操作

```bash
# 1. 変更を修正
# 2. Format
terraform fmt
# 3. Plan
terraform plan
# 4. Apply
terraform apply
```

## terraform コマンドのインストール

```bash
# terraform のバージョン管理のためにtfenvを利用する
brew install tfenv
# .terraform-version があるフォルダで、versionがインストールされてなければインストール
tfenv install 1.6.5
terraform -v
```

## インフラリソースを編集するための権限設定

インフラリソースへの影響を最小限にするため、tfstateの管理は一元管理しておらず、データストレージやサービスごとにtfstateを作成し、運用することにしている。（フォルダ構成の説明は後述）
そのため各tfstate管理フォルダで、適切に権限設定が必要である。

```bash
# 権限のあるアカウントへログインし、セット
gcloud auth login
gcloud config set account <your_account_mail>

# tfstateのある（.terraformフォルダがある）フォルダへ移動
cd dev/~~

# 環境ごとにプロジェクトを設定
gcloud config set project <your_project_id>
```

## tfstate管理のBucketの設定

tfstate は gcs で管理する。（google providerに関しては）

wip: セキュアな情報は、terraform.tfvars で管理し、シークレットマネージャーや 1pass で管理する

```bash
# bucketがない場合は作成する
gsutil mb gs://dev-tfstate
```
