---
title: "Terraformハンズオン - できるだけ何も考えず、とりあえず使ってみよう"
emoji: "💡"
type: "tech"
topics:
  - "terraform"
  - "googlecloud"
  - "iac"
published: true
published_at: "2024-07-28 19:02"
---

# はじめに

「約5年開発してきた自社サービス（チケット販売、配信、EC、データ基盤など）にIaCを導入する」という自分のコンテキストがあり、実際にIaCとして、Terraformを本番運用しているサービスにゼロから導入するにあたって、なーんかしっくりくるまで大変だったなーという思いがあります。

その理由の一つに、IaCは「hello, world!」的なことを行うハードルが高いからだと思っています。記事を読んだり動画を見たりでなんとなく分かったつもりにはなるんだけど、実際に触ってみないことには真に理解できないということは不思議と多々あります。（hello, world一応あるけど実際にクラウドのインフラ作らないケースが多いのであんまおもしろくはないと思う）

これからIaCを導入する人、IaCが導入されているチームにいるけど一部開発者しか触れてなくて正直よく分かってない人向けに、まずはとりあえず何も考えずに、IaC（Terraform）を体験してみるのがいいかなと思い雑に書いています。なのでチームメンバー向けでもあり。

※できる限り環境構築が不要になるように、実際のクラウド（Google Cloud）のインフラリソースを構築します

[とにかくハンズオンを始める](#%E3%83%8F%E3%83%B3%E3%82%BA%E3%82%AA%E3%83%B3)

## この記事を読むと嬉しいことがあるかもしれない人

- IaCとしてTerraformを導入したいんだけど何から始めたらいいか分からない
- なんかよくわからんけど、コード書いたらインフラできるんでしょ？くらいの理解で、実際に触ったことがないので正直ピンときてない
- IaCがプロダクトに導入されてるけど、自分は触ったことないのでなんか触るの怖い
- 触ってみたいけど、terraformインストールしたり、Google CloudやAWSなどどのプロバイダに対して実行したらいいんだか分からなくて結局手をつけられていない

## Terraform導入前のコンテキスト
※参考までになので飛ばしていいです

- 約5年開発してきた自社サービス（チケット販売、配信、EC、データ基盤など）に、IaCを導入する
    - IaCの存在は知ってるけど手をつけられずにいた
- それまでのインフラ管理
    - アプリケーションコードは Buildpack を使用してデプロイ
        - → コードから勝手にビルドしてデプロイ。
    - それ以外のインフラはコンソールで手動設定
- ざっくりサービス技術スタック
    - フロントエンド
        - React x Typescript
    - バックエンド
        - Node x Typescript
    - monorepo運用

## Terraformにしっくりくるまでの個人的ロードマップ
※参考までになので飛ばしていいです

- 動画や記事などで用語ざっくり理解
    - [【入門】Terraformの基礎を90分で解説するチュートリアル - YouTube](https://www.youtube.com/watch?si=VJ7KagZXTwRaEEdQ&v=h1MDCp7blmg&feature=youtu.be)
- **何も考えず触ってみる ← 今回はここに焦点を当てる**
    - [Terraform を使って Google Cloud のリソースを管理することはじめ（gloud authを利用）](https://zenn.dev/waddy/articles/terraform-google-cloud)
        - これよかった
- 本番運用を考えるといろいろむっずと感じる
    - [O'Reilly Japan - 詳解 Terraform 第3版](https://www.oreilly.co.jp/books/9784814400522/) で疑問点解決
- あとはやっていき

## ここでは書かないこと（需要あれば別途書きたい）
※参考までになので飛ばしていいです
ハンズオン後に必要あれば読む

- 本番運用するにあたって気になるだろうこと（自分が本番運用を始めるにあたっていろいろ気になってなかなか進まなかったやーつ。現状は一定の解を持ってプロダクト運用できています。キーワードだけ置いておく）
    - なぜIaCが必要なんだろう？
        - [なぜ「Infrastructure as Code」が必要なのか - Speaker Deck](https://speakerdeck.com/fu3ak1/naze-infrastructure-as-code-gabi-yao-nafalseka)
    - IaCってTerraform以外も選択肢としてあるけど、Terraformでいいんだろうか？
        - Terraformは宣言的である
    - インフラ構築となると、コードの構成によっては改修するの大変なんじゃないか？最適なフォルダ構成があるんだろうか？
        - 変更が最小限の影響で済む構成にする
        - [Terraformのフォルダ構成ってどうしたらいい？ → 最小限の影響で済むことを意識したトレードオフ分析を行う](https://zenn.dev/sbleru/articles/1ebe1d05b18292)
    - もしリファクタリングしたいってなったらどうするんだろう？
        - movedブロック
    - セキュアな情報はどう管理すればいいんだろう？
    - インフラがすでに本番稼働してるんだけどどうしたらいいんだろう？
        - importブロック
    - 開発環境や本番環境はどのように管理したらいいんだろう？
        - 分けよう
    - チームで運用する上で気をつけるべきことはなんだろう？
        - 単一ブランチを正とする。同じリソースを同時に修正する時は要注意
    - インフラコードの適用はどうするんだろう？ローカルからやるの？
        - GitHub Actionなどの実行環境を作る
    - Terraformでインフラリソースの構築ができるのはわかった。じゃあアプリケーションコードの変更をサービスに反映するにはどうしたらいいんだろう？
    - コードレビューってどうしたらいいんだろう？
        - tfcmtが便利
    - Terraformはどういう仕組みでインフラに変更を加えているんだろう？
        - [tfstateファイルについての基礎 コアやプロバイダ、tfstateファイルの役割について理解しよう | エンベーダー](https://envader.plus/article/199)
    - フォーマットや文法チェック、静的解析はどうしたらいいんだろう？
        - `terraform fmt` 、 `terraform validate` 、tflint
    - テストとかどうするんだろう？
    - あるインフラをコードに落とし込む時に何からやればいいんだろう？コードはどこから探したらいいんだろう？
        - プロバイダがdocを提供してくれている
            - Googleの場合 [Docs overview | hashicorp/google | Terraform | Terraform Registry](https://registry.terraform.io/providers/hashicorp/google/latest/docs)
    - 緊急対応で、IaC管理されているインフラを手動で設定したい場合はどうしたらいいんだろう？

# ハンズオン

- ※30min~1hくらい
- ※自分はMacOSでやっています
- ※dockerはインストールされている前提で進めます
- ※Dockerなど、用意されているコードを理解しようとしないでください。目的はあくまでTerraformというコードで、インフラが出来上がることを体験することだけです。分からない部分は分からないまま受け入れてください。

## ゴール

- TerraformでCloud Run Serviceを作成し、URLにアクセスできる（webで以下が表示される）
    ![](https://storage.googleapis.com/zenn-user-upload/57ef4d49cdbb-20240728.png)
- Terraformで、Cloud Run Serviceに変更を加える
- Terraformで、Cloud Run Serviceを削除する

## 事前準備

リポジトリをクローンする

```bash
git clone git@github.com:sbleru/terraform-handson.git
cd terraform-handson
```

gcloudやterraformを実行するためのコンテナ環境を構築し、コンテナに入る

```bash
# イメージのビルド
docker-compose build
# コンテナの起動
docker-compose up -d
# コンテナに入る
docker-compose exec tf-sandbox /bin/bash
```

以降、コンテナ内での処理

gcloud cliの認証を行う

```bash
# Googleプロジェクトを作成したいアカウントでGoogleログインする
gcloud auth login
```

Googleプロジェクトを作成する

`my-tf-handson` の名前で作成するため、名前を変更する場合は以降の処理を適宜書き換えてください

```bash
# Googleプロジェクトを作成する
export GOOGLE_PROJECT_ID=my-tf-handson
gcloud projects list | grep $GOOGLE_PROJECT_ID || gcloud projects create $GOOGLE_PROJECT_ID --name="My Terraform Hands On"
```

アクセスしてプロジェクトを確認してみる

```bash
echo https://console.cloud.google.com/home/dashboard?project=$GOOGLE_PROJECT_ID
# https://console.cloud.google.com/home/dashboard?project=my-tf-handson
```

![](https://storage.googleapis.com/zenn-user-upload/4d7be4f5621b-20240728.png)

クレデンシャルを生成する
```bash
gcloud auth application-default login
```

支払いの紐付けを行う（インフラリソースを作成するため、プロジェクトに請求アカウントを紐づける必要があります）

billingアカウントの確認と設定
```bash
gcloud beta billing accounts list
# ACCOUNT_ID            NAME              OPEN   MASTER_ACCOUNT_ID
# hogehoge  sbleru            True
```

対象のACCOUNT_IDを指定
```bash
export BILLING_ACCOUNT_ID=hogehoge
```

紐付けの実行
```bash
gcloud beta billing projects link $GOOGLE_PROJECT_ID --billing-account=$BILLING_ACCOUNT_ID
```

紐付け状態の確認
```bash
gcloud beta billing projects describe $GOOGLE_PROJECT_ID
```
- ※初回のみ必要です
- ※課金されないように、このハンズオンが終わり次第、プロジェクトを削除すると安心です

対象のプロジェクトをセットする
```bash
gcloud config set project $GOOGLE_PROJECT_ID
```

## Terraformでインフラリソースを作成してみよう

事前準備の続きで、引き続きコンテナ内で操作します

Terraformの初期化（基本初回のみ）

```bash
# terraformの実行フォルダへ移動する
cd terraform/cloud_run_service_example/
# 初期化
terraform init
```

Terraformコードからどんなインフラが構築されるかの差分を確認する

```bash
terraform plan
# GOOGLE_PROJECT_ID を変更している場合は外から変数を渡してください
# terraform plan -var="google_project_id=$GOOGLE_PROJECT_ID"
```

- plan結果
    ```bash
    Plan: 3 to add, 0 to change, 0 to destroy.
    ```    
    - addが作成、changeが変更、destroyが削除の意味。ここでは3つのインフラリソースが作成されることがわかる

Terraformコードからインフラを適用する

```bash
# インフラの適用（yesを入れると実際に適用が開始されます）
terraform apply
# GOOGLE_PROJECT_ID を変更している場合は外から変数を渡してください
# terraform apply -var="google_project_id=$GOOGLE_PROJECT_ID"
#Do you want to perform these actions?
#  Terraform will perform the actions described above.
#  Only 'yes' will be accepted to approve.
#
#  Enter a value: yes
```

Cloud Run Serviceが作成されているか確認する

```bash
# 出力変数から、cloud run serviceのuriを確認する
terraform output
# cloud_run_service_uri = "xxx"
```

`cloud_run_service_uri` をブラウザアクセスしてみる

![](https://storage.googleapis.com/zenn-user-upload/22df5b4aab1f-20240728.png)

コンソールからCloud Run Serviceへアクセスしてみる

```bash
echo https://console.cloud.google.com/run?project=$GOOGLE_PROJECT_ID
# https://console.cloud.google.com/run?project=my-tf-handsonf
```

![](https://storage.googleapis.com/zenn-user-upload/c72e32bd24f1-20240728.png)

Terraformでインフラができました！！

## Terraformでインフラリソースを変更してみよう

Cloud Run Serviceには環境変数を設定できるため、設定してみる。

現状を確認してみる
https://console.cloud.google.com/run/deploy/us-central1/cloudrun-service?project=my-tf-handson
「Cloud Run Serviceを選択」→「Edit」→「CONTAINER(S)」→「VARIABLES & SECRETS」→「Environment variables」

![](https://storage.googleapis.com/zenn-user-upload/cee88f7e92ee-20240728.png)

envブロックのコメントアウトを外してみる

`terraform-handson/terraform/cloud_run_service_example/main.tf`

https://github.com/sbleru/terraform-handson/blob/0500c2150d4fac1eb2869d29c3064cc845ceeeb2/terraform/cloud_run_service_example/main.tf#L10-L17

terraform planを実行する

```bash
terraform plan
```
- `+ env` となっており、環境変数が追加されることがわかる。

terraform applyを実行する

```bash
# yesと答える
terraform apply
```

再度確認してみる

https://console.cloud.google.com/run/deploy/us-central1/cloudrun-service?project=my-tf-handson

「Cloud Run Serviceを選択」→「Edit」→「CONTAINER(S)」→「VARIABLES & SECRETS」→「Environment variables」

![](https://storage.googleapis.com/zenn-user-upload/4eb04a17681e-20240728.png)

環境変数が増えていることが確認できる

## Terraformでインフラリソースを削除してみよう

※削除は危険な行為なので、本番運用の際は最善の注意を払う必要がありますが、今回はハンズオンなので気軽に消し飛ばしましょう

削除planを実行する

```bash
terraform plan -destroy
```

- `Plan: 0 to add, 0 to change, 3 to destroy.` のように、destroyされる数が表示される

削除applyを実行する

```bash
terraform apply -destroy
```

- yesと答えると削除が開始される

クラウドコンソールで確認してみる

https://console.cloud.google.com/run?referrer=search&project=my-tf-handson

![](https://storage.googleapis.com/zenn-user-upload/d185dad5d36a-20240728.png)

削除されていることが確認できる

ここで再び作成処理を行うこともできます [Terraformでインフラリソースを作成してみよう](https://www.notion.so/Terraform-ba9e02b17ebf4f569b5a48042eb1fb8b?pvs=21) 

その際作成されたCloud Run ServiceのURLが前回とは異なることに注目してください。つまり、同じCloud Run Serviceでも全く異なる実体が生成されます。

## 他のインフラリソースの変更もやってみる

この記事では掘り下げませんが、クラウドプロバイダーごとにインフラリソースを表現するコードドキュメントが提供されています。

今回はこちらのコードを持ってきています。いろいろ設定値があるので遊んでみてください。

[google_cloud_run_v2_service | Resources | hashicorp/google | Terraform | Terraform Registry](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/cloud_run_v2_service)

## プロジェクトの削除

ひととおり遊んで満足したらプロジェクトを削除してしまいましょう

（Cloud Run Serviceに関してはアクセスがなければ課金されないと思いますが）

```bash
gcloud projects delete $GOOGLE_PROJECT_ID
```

**ハンズオン終わり！**

# おわりに

実際に本番運用を意識するとなると、 [ここでは書かないこと](#%E3%81%93%E3%81%93%E3%81%A7%E3%81%AF%E6%9B%B8%E3%81%8B%E3%81%AA%E3%81%84%E3%81%93%E3%81%A8%EF%BC%88%E9%9C%80%E8%A6%81%E3%81%82%E3%82%8C%E3%81%B0%E5%88%A5%E9%80%94%E6%9B%B8%E3%81%8D%E3%81%9F%E3%81%84%EF%BC%89) で記載したようなことがいろいろ気になると思います。
ただ、とにかくTerraformを触ってみることができたことで、理解は進みやすくなるんじゃないかな、そうなっていたらいいな、と思います。
記事書けたら書きますmm

また、Terraform外観掴んだし、触ってみれたしって人はこの本読んだら大抵の問題は解決すると思います。
[O'Reilly Japan - 詳解 Terraform 第3版](https://www.oreilly.co.jp/books/9784814400522/)
※NotebookLMにPDFぶっ込んで質問するのもおすすめです。

# 参考

- [Terraform | HashiCorp Developer](https://developer.hashicorp.com/terraform)
- [5分で分かるTerraform（Infrastructure as Code） | LAC WATCH](https://www.lac.co.jp/lacwatch/service/20200903_002270.html)
- [【入門】Terraformの基礎を90分で解説するチュートリアル - YouTube](https://www.youtube.com/watch?v=h1MDCp7blmg)
- [Terraform を使って Google Cloud のリソースを管理することはじめ（gloud authを利用）](https://zenn.dev/waddy/articles/terraform-google-cloud)
- [Terraform の状態を Cloud Storage バケットに保存する  |  Google Cloud](https://cloud.google.com/docs/terraform/resource-management/store-state?hl=ja)
